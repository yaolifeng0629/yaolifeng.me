## å‰ç«¯â€”å›¾ç‰‡æ¸è¿›å¼åŠ è½½å®è·µæŒ‡å—

### å‰è¨€

-   Hey, æˆ‘æ˜¯ Immerse
-   æ–‡ç« é¦–å‘äºä¸ªäººåšå®¢ã€https://yaolifeng.comã€‘ï¼Œæ›´å¤šå†…å®¹è¯·å…³æ³¨ä¸ªäººåšå®¢
-   è½¬è½½è¯´æ˜ï¼šè½¬è½½è¯·åœ¨æ–‡ç« å¤´éƒ¨æ³¨æ˜åŸæ–‡å‡ºå¤„åŠç‰ˆæƒå£°æ˜ï¼

### èµ·å› 

-   æœ€è¿‘ä¸Šçº¿äº†[ä¸ªäººåšå®¢](https://yaolifeng.com)ï¼Œç‰‡æ®µé¡µé¢å­˜åœ¨å¤§é‡å›¾ç‰‡ï¼Œåœ¨å›¾ç‰‡åŠ è½½æ–¹é¢ä½“éªŒå¾ˆå·®ï¼Œå¯ä»¥è¯´æ˜¯æ–­å´–å¼ï¼Œä» 0-1 å®Œå…¨æ²¡æœ‰ä»»ä½•è¿‡æ¸¡ï¼ˆè¿™å¾ˆå½±å“é¡µé¢å¸ƒå±€å’Œç”¨æˆ·ä½“éªŒï¼Œå¯¹äºè®¾å®šäº†å›¾ç‰‡å®½é«˜çš„å›¾ç‰‡è¿˜å¥½ï¼Œå¦‚æœæ²¡è®¾ç½®ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªå›¾ç‰‡æ’‘é«˜çš„è¿‡ç¨‹ï¼‰

### å·§åˆ

-   åœ¨å‡†å¤‡å†™è¿™ç¯‡æ–‡ç« å½“å¤©å‰ç«¯å—ç–å¤§ä½¬å‘è¡¨äº†ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ç›´å‘¼å¤§æ•°æ®ç‰›é€¼ ğŸ‘ğŸ»[æ–‡ç« : ç‚¹å‡»æŸ¥çœ‹](https://mp.weixin.qq.com/s/rNOWMPh1sOhVqpRe2dxfvA)
-   è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°†è®¨è®ºå…¶ä»–å‡ ç§æ–¹æ¡ˆï¼Œé—²è¯å°‘è¯´ï¼Œè¨€å½’æ­£ä¼ ã€‚
    -   å¯¹äºå¸¸è§„çš„å›¾ç‰‡ä¼˜åŒ–è¿™é‡Œä¸åœ¨èµ˜è¿°ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š
        -   å‹ç¼©å›¾ç‰‡ã€ä½¿ç”¨ CSS spritesã€æ‡’åŠ è½½ã€é¢„åŠ è½½ã€CDN ç¼“å­˜ã€åˆé€‚çš„å›¾ç‰‡æ ¼å¼ã€ä¸ƒç‰› CDN å›¾ç‰‡å‚æ•°ç­‰ç­‰

### æ¢ç´¢

-   ä»¥ä¸‹æ˜¯è¿™ç¯‡æ–‡ç« æåˆ°çš„å‡ ç§æ–¹æ¡ˆï¼ˆå› ä¸ºä¸ªäººé¡¹ç›®åŸºäº Nextï¼Œæ‰€ä»¥æœ‰äº›ç¤ºä¾‹ä»£ç æ˜¯ Reactï¼‰
    -   ï¼ˆ1ï¼‰ä½¿ç”¨å›¾ç‰‡ä¸»è‰²è°ƒ
    -   ï¼ˆ2ï¼‰ä½¿ç”¨æŸä¸ªé¢œè‰²
    -   ï¼ˆ3ï¼‰ä½¿ç”¨å›¾ç‰‡çš„ç¼©ç•¥å›¾
    -   ï¼ˆ4ï¼‰ä½¿ç”¨æ¨¡ç³Š + å‹ç¼©å›¾ç‰‡
    -   ï¼ˆ5ï¼‰å›¾ç‰‡å ä½ç¬¦

#### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨å›¾ç‰‡ä¸»è‰²è°ƒ

-   åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬çš„å›¾ç‰‡ `src` å¯èƒ½æ˜¯åŠ¨æ€çš„ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² `string` url, å½“æˆ‘ä»¬æŒ‡å®šäº† `placeholder="blur"` æ—¶ï¼Œè¿˜å¿…é¡»æ·»åŠ  [`blurDataURL`](https://nextjs.org/docs/pages/api-reference/components/image#blurdataurl) å±æ€§ï¼Œ

```jsx
import Image from 'next/image';

// Pixel GIF code adapted from https://stackoverflow.com/a/33919020/266535
const keyStr = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';

const triplet = (e1: number, e2: number, e3: number) =>
    keyStr.charAt(e1 >> 2) +
    keyStr.charAt(((e1 & 3) << 4) | (e2 >> 4)) +
    keyStr.charAt(((e2 & 15) << 2) | (e3 >> 6)) +
    keyStr.charAt(e3 & 63);

const rgbDataURL = (r: number, g: number, b: number) =>
    `data:image/gif;base64,R0lGODlhAQABAPAA${
        triplet(0, r, g) + triplet(b, 255, 255)
    }/yH5BAAAAAAALAAAAAABAAEAAAICRAEAOw==`;

const Color = () => (
    <div>
        <h1>Image Component With Color Data URL</h1>
        <Image
            alt="Dog"
            src="/dog.jpg"
            placeholder="blur"
            blurDataURL={rgbDataURL(237, 181, 6)}
            width={750}
            height={1000}
            style={{
                maxWidth: '100%',
                height: 'auto'
            }}
        />
        <Image
            alt="Cat"
            src="/cat.jpg"
            placeholder="blur"
            blurDataURL={rgbDataURL(2, 129, 210)}
            width={750}
            height={1000}
            style={{
                maxWidth: '100%',
                height: 'auto'
            }}
        />
    </div>
);

export default Color;
```

#### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨æŸä¸ªé¢œè‰²

-   åœ¨ `next.config.js` ä¸­é…ç½® [`placeholder`](https://nextjs.org/docs/pages/api-reference/components/image#placeholder) ä¸º `color`ï¼Œç„¶åä½¿ç”¨ `backgroundColor` å±æ€§

```js
// next.config.js
module.exports = {
    images: {
        placeholder: 'color',
        backgroundColor: '#121212'
    }
};
```

```tsx
// ä½¿ç”¨
<Image src="/path/to/image.jpg" alt="image title" width={500} height={500} placeholder="color" />
```

#### æ–¹æ¡ˆ 3: ä½¿ç”¨å›¾ç‰‡çš„ç¼©ç•¥å›¾

```html
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>æ¸è¿›å¼å›¾ç‰‡åŠ è½½</title>
        <style>
            .placeholder {
                background-color: #f6f6f6;
                background-size: cover;
                background-repeat: no-repeat;
                position: relative;
                overflow: hidden;
            }

            .placeholder img {
                position: absolute;
                opacity: 0;
                top: 0;
                left: 0;
                width: 100%;
                transition: opacity 1s linear;
            }

            .placeholder img.loaded {
                opacity: 1;
            }

            .img-small {
                filter: blur(50px);
                transform: scale(1);
            }
        </style>
    </head>
    <body>
        <div
            class="placeholder"
            data-large="https://qncdn.mopic.mozigu.net/work/143/24/42b204ae3ade4f38/1_sg-uLNm73whmdOgKlrQdZA.jpg"
        >
            <img
                src="https://qncdn.mopic.mozigu.net/work/143/24/5307e9778a944f93/1_sg-uLNm73whmdOgKlrQdZA.jpg"
                class="img-small"
            />
            <div style="padding-bottom: 66.6%"></div>
        </div>
    </body>
</html>
<script>
    window.onload = function () {
        var placeholder = document.querySelector('.placeholder'),
            small = placeholder.querySelector('.img-small');

        // 1. æ˜¾ç¤ºå°å›¾å¹¶åŠ è½½
        var img = new Image();
        img.src = small.src;
        img.onload = function () {
            small.classList.add('loaded');
        };

        // 2. åŠ è½½å¤§å›¾
        var imgLarge = new Image();
        imgLarge.src = placeholder.dataset.large;
        imgLarge.onload = function () {
            imgLarge.classList.add('loaded');
        };
        placeholder.appendChild(imgLarge);
    };
</script>
```

#### æ–¹æ¡ˆ 4ï¼šä½¿ç”¨æ¨¡ç³Š+å‹ç¼©å›¾ç‰‡

```tsx
// progressive-image,tsx
'use client';

import React, { useState, useEffect } from 'react';
import imageCompression from 'browser-image-compression';

interface ProgressiveImageProps {
    src: string;
    alt?: string;
    width?: number;
    height?: number;
    layout?: 'fixed' | 'responsive' | 'fill' | 'intrinsic';
    className?: string;
    style?: React.CSSProperties;
}

export const ProgressiveImage: React.FC<ProgressiveImageProps> = ({
    src,
    alt = '',
    width,
    height,
    layout = 'responsive',
    className = '',
    style = {}
}) => {
    const [currentSrc, setCurrentSrc] = useState<string>(src);
    const [isLoading, setIsLoading] = useState<boolean>(true);
    const [blurLevel, setBlurLevel] = useState<number>(20);

    useEffect(() => {
        let isMounted = true;

        const loadImage = async () => {
            try {
                // åŠ è½½å¹¶å‹ç¼©åŸå§‹å›¾ç‰‡
                const response = await fetch(src);
                const blob = await response.blob();

                // ç”Ÿæˆä½è´¨é‡é¢„è§ˆå›¾
                const tinyOptions = {
                    maxSizeMB: 0.0002,
                    maxWidthOrHeight: 16,
                    useWebWorker: true,
                    initialQuality: 0.1
                };

                const tinyBlob = await imageCompression(blob, tinyOptions);
                if (isMounted) {
                    const tinyUrl = URL.createObjectURL(tinyBlob);
                    setCurrentSrc(tinyUrl);
                    // å¼€å§‹é€æ¸å‡å°æ¨¡ç³Šåº¦
                    startSmoothTransition();
                }

                // åŠ è½½åŸå§‹å›¾ç‰‡
                const highQualityImage = new Image();
                highQualityImage.src = src;
                highQualityImage.onload = () => {
                    if (isMounted) {
                        setCurrentSrc(src);
                        // å½“é«˜è´¨é‡å›¾ç‰‡åŠ è½½å®Œæˆæ—¶ï¼Œç»§ç»­å¹³æ»‘è¿‡æ¸¡
                        setTimeout(() => {
                            setIsLoading(false);
                        }, 100);
                    }
                };
            } catch (error) {
                console.error('Error loading image:', error);
                if (isMounted) {
                    setCurrentSrc(src);
                    setIsLoading(false);
                }
            }
        };

        const startSmoothTransition = () => {
            // ä»20pxçš„æ¨¡ç³Šé€æ¸è¿‡æ¸¡åˆ°10px
            const startBlur = 20;
            const endBlur = 10;
            const duration = 1000; // 1ç§’
            const steps = 20;
            const stepDuration = duration / steps;
            const blurStep = (startBlur - endBlur) / steps;

            let currentStep = 0;

            const interval = setInterval(() => {
                if (currentStep < steps && isMounted) {
                    setBlurLevel(startBlur - blurStep * currentStep);
                    currentStep++;
                } else {
                    clearInterval(interval);
                }
            }, stepDuration);
        };

        setIsLoading(true);
        setBlurLevel(20);
        loadImage();

        return () => {
            isMounted = false;
            if (currentSrc && currentSrc.startsWith('blob:')) {
                URL.revokeObjectURL(currentSrc);
            }
        };
    }, [src]);

    const getContainerStyle = (): React.CSSProperties => {
        const baseStyle: React.CSSProperties = {
            position: 'relative',
            overflow: 'hidden'
        };

        switch (layout) {
            case 'responsive':
                return {
                    ...baseStyle,
                    maxWidth: width || '100%',
                    width: '100%'
                };
            case 'fixed':
                return {
                    ...baseStyle,
                    width: width,
                    height: height
                };
            case 'fill':
                return {
                    ...baseStyle,
                    width: '100%',
                    height: '100%',
                    position: 'absolute',
                    top: 0,
                    left: 0
                };
            case 'intrinsic':
                return {
                    ...baseStyle,
                    maxWidth: width,
                    width: '100%'
                };
            default:
                return baseStyle;
        }
    };

    const getImageStyle = (): React.CSSProperties => {
        const baseStyle: React.CSSProperties = {
            filter: isLoading ? `blur(${blurLevel}px)` : 'none',
            transition: 'filter 0.8s ease-in-out', // å¢åŠ è¿‡æ¸¡æ—¶é—´
            transform: 'scale(1.1)', // ç¨å¾®æ”¾å¤§é˜²æ­¢æ¨¡ç³Šæ—¶å‡ºç°è¾¹ç¼˜
            ...style
        };

        switch (layout) {
            case 'responsive':
                return {
                    ...baseStyle,
                    width: '100%',
                    height: 'auto',
                    display: 'block'
                };
            case 'fixed':
                return {
                    ...baseStyle,
                    width: width,
                    height: height
                };
            case 'fill':
                return {
                    ...baseStyle,
                    width: '100%',
                    height: '100%',
                    objectFit: 'cover'
                };
            case 'intrinsic':
                return {
                    ...baseStyle,
                    width: '100%',
                    height: 'auto'
                };
            default:
                return baseStyle;
        }
    };

    return (
        <div className={`${className}`} style={getContainerStyle()}>
            {currentSrc && <img src={currentSrc} alt={alt} style={getImageStyle()} />}
        </div>
    );
};
```

```tsx
// ä½¿ç”¨
<ProgressiveImage
    src={photo}
    alt={short.title}
    width={300}
    height={250}
    layout="responsive"
    className="h-full min-h-[150px]"
/>
```

#### æ–¹æ¡ˆ 5ï¼šå›¾ç‰‡å ä½ç¬¦

-   Next.js çš„ [next/image](https://nextjs.org/docs/pages/api-reference/components/image) ç»„ä»¶ [`placeholder`](https://nextjs.org/docs/pages/api-reference/components/image#placeholder) å±æ€§æä¾›äº†ä¸ªé€‰é¡¹ `blur`ï¼Œé»˜è®¤ä¸º `empty`
    -   `blur` ä¼šç”Ÿæˆä¸€ä¸ªæ¨¡ç³Šçš„é¢„è§ˆå›¾åƒ(ä½†è¿™ä¸ªé€‰é¡¹ä¼šå¢åŠ åˆå§‹åŠ è½½å®è·µï¼Œå› ä¸ºéœ€è¦æ—¶é—´å»ç”Ÿæˆæ¨¡ç³Šå›¾ç‰‡)
    -   æ³¨æ„ï¼šå¦‚æœ `placeholder="blur"` æ—¶ï¼Œå¿…é¡»ä½¿ç”¨ `import` é™æ€å¼•å…¥å›¾ç‰‡çš„æ–¹å¼ï¼Œè¿™æ · Next.js æ‰ä¼šå¯¹å›¾ç‰‡è¿›è¡Œæ¸è¿›å¼åŠ è½½çš„é¢„å¤„ç†

```jsx
import Image from 'next/image';
import mountains from '/public/mountains.jpg';

const PlaceholderBlur = () => (
    <div>
        <h1>Image Component With Placeholder Blur</h1>
        <Image
            alt="Mountains"
            src={mountains}
            placeholder="blur"
            width={700}
            height={475}
            style={{
                maxWidth: '100%',
                height: 'auto'
            }}
        />
    </div>
);

export default PlaceholderBlur;
```

### æ€»ç»“

-   äº§å“ç¬¬ä¸€å°è±¡å¾ˆé‡è¦ï¼Œè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒå¯¹äºäº§å“æ¥è¯´æ˜¯å¿…éœ€çš„ã€‚
-   æ„Ÿè°¢é˜…è¯»ï¼Œæˆ‘ä»¬ä¸‹æ¬¡å†è§ï¼
